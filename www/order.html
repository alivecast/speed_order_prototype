<!DOCTYPE html>
<html>
<head>
<title></title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
<meta charset="utf-8">

<script type="text/javascript" charset="utf-8" src="js/jquery-1.8.2.min.js"></script>

<script src="http://localhost:8080/target/target-script-min.js#speed"></script>

<script type="text/javascript" charset="utf-8" src="js/base64.js"></script>
<script type="text/javascript" charset="utf-8" src="js/aes.js"></script>

<script type="text/javascript" charset="utf-8" src="js/main.js"></script>

<script type="text/javascript" charset="utf-8" src="js/cordova-1.5.0.js"></script>

<script type="text/javascript">

$( document ).bind( "mobileinit", function() {
	// jQuery Mobile フレームワークの設定変更は、ここで行なってください！
	$.support.cors = true;
	$.mobile.allowCrossDomainPages = true;
});

function onBodyLoad() {
	document.addEventListener("deviceready", onDeviceReady, false);
}

function onDeviceReady() {
	getSetting();
}

// 情報ファイルを読み込み
function getSetting(){
	window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, read, fail);
	function read(fileSystem) {

		// ファイルの読み込み
		var fname = 'ordering';
		var ordering = {};

		fileSystem.root.getFile(fname, {}, function(fileEntry) {
			fileEntry.file(function(file) {
				var text = {};
				var reader = new FileReader();
				reader.onloadend = function(evt) {
					// ここに読み込み完了後の処理を書く

console.log("text: " + evt.target.result);

					text = evt.target.result;
					ordering = JSON.parse(text);

console.log("正常にテキストを読み込みました。:cid "+ordering.customer_id);
console.log("正常にテキストを読み込みました。:key "+ordering.customer_key);

					// アドレスの取得
					setSetting(ordering);

				};
				reader.readAsText(file, "utf-8");
				// Data URL として読み込む
				// reader.readAsDataURL(file);
			}, fail)
		}, fail);

	}
}

// サーバー通信を行い値を設定を行なう
function setSetting(params){
	console.log("Start:"+params);

	var url = 'https://gs850.ggsv.jp/~w850033/class/json/send_setup.php';

	$.post(url, // アクセスするURL
		params, // 送信データ
		function(data, status, XHR) {// 処理結果
			if (status == 'success') {
				// 戻り値により処理を振り分ける
				if(data.setup_ok == 1){
console.log("-- 注文処理 --");
					getOrder(params);
				}else if(data.customer_ck == 0){
console.log("-- 個人設定・お届け先 --");
					location.href="ordering_new.html?kbn=buy";
				}else if(data.card_ck == 0){
console.log("-- カード--");
					location.href="card_new.html?kbn=buy";
				}else if(data.password_ck == 0){
console.log("-- 暗証番号--");
					location.href="passcode_new.html?kbn=buy";
				}else{
console.log("-- エラー１--");
					errMsg();
				}
			} else {
console.log("-- エラー２--");
				errMsg();
			}
		}
	);
console.log("-- END--");
}

// 情報ファイルを読み込み
function getOrder(params){

	window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, read, fail);
	function read(fileSystem) {

		// ファイルの読み込み
		var fname = 'order';
		var order = {};
        var postg = {};

        postg['customer_id']   = params.customer_id;
        postg['customer_key']  = params.customer_key;
        postg['item_id']      = "2";
        postg['company_id']   = "200101";
        postg['item_version']      = "3";
        postg['order_amount']      = "2";
        postg['qr_id']           = "2001010000040000028101";
        
        // アドレスの取得
        setOrder(postg);
//		fileSystem.root.getFile(fname, {}, function(fileEntry) {
//			fileEntry.file(function(file) {
//				var text = {};
//				var reader = new FileReader();
//				reader.onloadend = function(evt) {
//					// ここに読み込み完了後の処理を書く
//
//console.log("text: " + evt.target.result);
//
//					text = evt.target.result;
//					order = JSON.parse(text);
//
//console.log("正常にテキストを読み込みました。order");
//                    postg['custome_id']   = params.custome_id;
//                    postg['custome_key']  = params.custome_key;
//                    postg['item_id']      = order.item_id;
//                    postg['company_id']   = order.company_id;
//                    postg['item_version']      = order.item_version;
//                    postg['order_amount']      = order.order_amount;
//                    postg['qr_id']           = order.qr_id;
//                           
//
//                           // アドレスの取得
//					setOrder(postg);
//
//				};
//				reader.readAsText(file, "utf-8");
//				// Data URL として読み込む
//				// reader.readAsDataURL(file);
//			}, fail)
//		}, fail);
        
	}
}

// サーバー通信を行い値を設定を行なう
function setOrder(order){
	console.log("Start:"+order);

	var url = 'https://gs850.ggsv.jp/~w850033/class/json/receive_order_it.php';

	$.post(url, // アクセスするURL
		order, // 送信データ
		function(data, status, XHR) {// 処理結果
			if (status == 'success') {
				// 戻り値により処理を振り分ける
				if(data.order_id > 0 && data.order_id < 99999999999){
console.log("-- 注文完了--");
					okMsg();
                    return false;
				}else{
console.log("-- エラー１--");
					errMsg();
                    return false;
				}
			} else {
console.log("-- エラー２--");
				errMsg();
                return false;
			}
		}
	);
console.log("-- END--");
}

function okMsg() {
	message = 'キャンセルは30分以内にお願いいたします。';
	title = 'ご注文が完了いたしました。';
	button = 'OK';
	navigator.notification.alert(message, alertCallBackOk(), title, button);
	location.href = 'show_order.html';
}
    function alertCallBackOk() {
//        location.href = 'show_order.html';
    }
    
    function errMsg() {
        message = '時間をおいてやり直してください';
        title = 'サーバーと通信できませんでした';
        button = 'OK';
        navigator.notification.alert(message, alertCallBack(), title, button);
        location.href = 'setting.html';
    }
    
function alertCallBack() {
//	location.href = 'show_item.html';
}

</script>
</head>
<body onload="onBodyLoad()">
</body>
</html>
